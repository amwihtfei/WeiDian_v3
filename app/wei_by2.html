<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>确认下单</title>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta name="format-detection" content="telephone=no">
    <link href="Public/css/bootstrap.css" rel="stylesheet">
    <link href="Public/css/base.css" rel="stylesheet">
    <link href="Public/css/main.css" rel="stylesheet">
    <link href="Public/css/font-awesome.css" rel="stylesheet">
    <link href="Public/css/button.css" rel="stylesheet">
</head>
<body>
<form method="post" action="">
  <section class="wei-iContainer">
    <div class="order-list pl10 pr10">
      <ul class="mt10">
        <li>
          <a href="#" class="js-buy-cal list-content clearfix">
            <span class="order-pro-img"><img src="Public/img/a1.jpg" class=""></span>
            <span class="order-list-con clearfix">
              <span class="order-list-title">
                <span class="overTextH">促阿迪达斯男2014清风运动跑步鞋F促阿迪达斯男2014清风运动跑步鞋F3250432504</span>
                <span class="color-999">（男款xxx）</span>
              </span>
              <span class="js-buy-price order-list-price mt10 text-right" data-price="1000.00">￥1000.00<br><span class="js-buy-num color-999" data-num="1">x1</span></span>
            </span>
          </a>
        </li>
        <li>
          <a href="#" class="js-buy-cal list-content clearfix">
            <span class="order-pro-img"><img src="Public/img/a1.jpg" class=""></span>
            <span class="order-list-con clearfix">
              <span class="order-list-title">
                <span class="overTextH">促阿迪达斯男2014清风运动跑步鞋F促阿迪达斯男2014清风运动跑步鞋F3250432504</span>
                <span class="color-999">（男款xxx）</span>
              </span>
              <span class="js-buy-price order-list-price mt10 text-right" data-price="1000.00">￥1000.00<br><span class="js-buy-num color-999" data-num="1">x1</span></span>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </section>
  <section class="">
    <div class="ml10 mr10">
      <div class="clearfix bb lh40">
        <div class="pull-left">
          姓名
        </div>
        <div class="pull-right">
          sadadadkjasljaskldj
        </div>
      </div>
      <div class="clearfix bb lh40">
        <div class="pull-left">
          手机
        </div>
        <div class="pull-right">
          1111111111
        </div>
      </div>
      <div class="clearfix bb lh40">
        <div class="pull-left">
          地址
        </div>
        <div class="pull-right">
          sadadadkjasljaskldj
        </div>
      </div>
      <div class="clearfix bb lh40">
        <div class="pull-left">
          配送方式
        </div>
        <div class="pull-right">
          <select class="chooseExpress fs12 lh30" style="width: 100%;">
            <option value="" data-value="22.00" selected="selected">包邮</option>
          </select>
        </div>
      </div>
      <div class="clearfix lh40">
        <textarea placeholder="告诉卖家您的要求吧...（限150个字）"
                  class="mt5 mb5 lh30" style="background-color: #f5f5f5;text-indent: 6px;width: 100%;height: 60px;"></textarea>
      </div>
    </div>

  </section>
  <input type="hidden" id="inv" value=""/>
  <div style="height: 40px;"></div>
  <section class="buy-foot text-right bt">
    合计:<span class="color-theme2 mr10">￥<span class="js-buy-listRmb"></span></span>
    <a href="#" class="wei-btn wei-bg-sRed pull-right" style="width: 33.3%;line-height: 40px; border-radius: 0;">确认订单</a>
  </section>
</form>
<script src="Public/js/jquery-1.8.3.js"></script>
<script src="Public/js/bootstrap.js"></script>
<script src="Public/js/BigDecimal-all-last.min.js"></script>
<script src="Public/js/tools.js"></script>
<script src="Public/js/jquery.cookie.js"></script>
<script src="Public/js/jinniu.mobile.js"></script>
<script>
  $(function () {

    function GetRandomNum(Min,Max)
    {
      var Range = Max - Min;
      var Rand = Math.random();
      return(Min + Math.round(Rand * Range));
    }

    var data = {
      t1:{},
      t2:{}
    }

    var isExist = false;  //cookie是否存在
    var isOpen = false;    //开关是否开启
    var isTabNor = true;  //判断普通发票(true)还是增值税发票(false)
    var isAddOrUpdate = true;   //判断新增(true)还是修改(false)

    //判断cookie是否存在
    var tabdata = $.cookie('tabData'); // 读取 cookie
    if(tabdata != null && tabdata != undefined && tabdata != ''){
      isExist = true;
      isOpen = true;
      data=JSON.parse(tabdata);
      if(data['t1'].title != null && data['t1'].title != undefined && data['t1'].title != ''){
        isTabNor = true;
      }else{
        isTabNor = false;
      }

      if(isTabNor){
        if(data['t1'].title != null && data['t1'].title != undefined && data['t1'].title != ''){
          $('#inv').val(JSON.stringify(data['t1']));
          $('.js-title').html(data['t1'].title);
          $('.js-con').html(data['t1'].con);

          switchCtrl(true);
        }

      }else{
        if(data['t2'].com_name != null && data['t2'].com_name != undefined && data['t2'].com_name != ''){
          $('#inv').val(JSON.stringify(data['t2']));
          $('.js-title').html(data['t2'].com_name);
          $('.js-con').html(data['t2'].con);

          switchCtrl(true);
        }

      }
    }

    //开具发票
    $('.js-buy-invoice').change(function () {
      if($(this).attr('checked')){
        //开
        isOpen = true;
        isAddOrUpdate = true;
      }else{
        //关
        isOpen = false;
        isAddOrUpdate = false;
      }
      invoice_add();
    });

    //开关控制
    function switchCtrl(flag){
      if(flag){
        //开
        $('.js-buy-invoice').attr('checked', true);
        $('.js-buy-ani2').height('40px');
        $('#b-txt').hide();
      }else{
        //关
        $('.js-buy-invoice').attr('checked', false);
        $('.js-buy-ani2').height('0');
        $('#b-txt').show();
      }

    }


    //添加发票
    function invoice_add(){
      $.cookie('tabData', null, { expires: -1, path:"/", domain:"shop.golddiy.com"});
      if(isOpen){
        //开
        if(isTabNor){
          if(data['t1'].title != null && data['t1'].title != undefined && data['t1'].title != ''){
            $('.js-title').html(data['t1'].title);
            $('.js-con').html(data['t1'].con);
          }

        }else{
          if(data['t2'].com_name != null && data['t2'].com_name != undefined && data['t2'].com_name != ''){
            $('.js-title').html(data['t2'].com_name);
            $('.js-con').html(data['t2'].con);
          }

        }

        $('input[name="title"]').val('');
        $('input[name="ho-con"]').each(function(){
          $(this).attr("checked",false);
        });

        $('input[name="com_name"]').val('');
        $('input[name="com_code"]').val('');
        $('input[name="com_address"]').val('');
        $('input[name="com_phone"]').val('');
        $('input[name="com_bank"]').val('');
        $('input[name="com_bankAccount"]').val('');
        $('input[name="ho-con2"]').each(function(){
          $(this).attr("checked",false);
        });

        switchCtrl(true);

        //滑出蒙层，开具发票
        $('#popUpWrap').removeClass('none');
        $('.pop-up').height(400);
      }else{
        //关
        switchCtrl(false);

        data['t1'].title = null;
        data['t1'].con = null;
        data['t2'].com_name = null;
        data['t2'].com_code = null;
        data['t2'].com_address = null;
        data['t2'].com_phone = null;
        data['t2'].com_bank = null;
        data['t2'].com_bankAccount = null;
        data['t2'].con = null;
      }
    }

    //发票修改按钮
    $('.js-update').click(function () {
      isAddOrUpdate = false;
      if(isTabNor){
        //若为普通发票
        $('input[name="title"]').val(data['t1'].title);
        $('input[name="ho-con"]').each(function(){
          if($(this).data('v') == data['t1'].con){
            $(this).attr("checked",true);
          }
        });

        $('.order-cur').removeClass('order-cur');
        $('.js-tab ul li:first').addClass('order-cur');
        $('.js-tab').siblings('div').addClass('hide');
        $('.js-tab').siblings('div').eq(0).removeClass('hide');
      }else{
        //若为增值税发票
        $('input[name="com_name"]').val(data['t2'].com_name);
        $('input[name="com_code"]').val(data['t2'].com_code);
        $('input[name="com_address"]').val(data['t2'].com_address);
        $('input[name="com_phone"]').val(data['t2'].com_phone);
        $('input[name="com_bank"]').val(data['t2'].com_bank);
        $('input[name="com_bankAccount"]').val(data['t2'].com_bankAccount);
        $('input[name="ho-con2"]').each(function(){
          if($(this).data('v') == data['t2'].con){
            $(this).attr("checked",true);
          }
        });

        $('.order-cur').removeClass('order-cur');
        $('.js-tab ul li:last').addClass('order-cur');
        $('.js-tab').siblings('div').addClass('hide');
        $('.js-tab').siblings('div').eq(1).removeClass('hide');
      }
      //滑出蒙层，开具发票
      $('#popUpWrap').removeClass('none');
      $('.pop-up').height(400);


    });

    $('.js-mask, .js-x').click(function(){
      if(isAddOrUpdate){
        //若为新增是滑窗
        switchCtrl(false);
        isOpen = false;

        $('.pop-up').height('0');
        setTimeout(function(){
          $('#popUpWrap').addClass('none');
        },600);

        //清空表单
        if(isAddOrUpdate){
          //普通发票
          //获取表单元素的值
          data['t1'].title = $('input[name="title"]').val();
          data['t1'].con = $('input[name="ho-con"]:checked').data('v');
        }else{
          //增值税发票
          data['t2'].com_name = $('input[name="com_name"]').val();
          data['t2'].com_code = $('input[name="com_code"]').val();
          data['t2'].com_address = $('input[name="com_address"]').val();
          data['t2'].com_phone = $('input[name="com_phone"]').val();
          data['t2'].com_bank = $('input[name="com_bank"]').val();
          data['t2'].com_bankAccount = $('input[name="com_bankAccount"]').val();
          data['t2'].con = $('input[name="ho-con2"]:checked').data('v');
        }

      }else{
        //若为修改时滑窗
        $('.pop-up').height('0');
        setTimeout(function(){
          $('#popUpWrap').addClass('none');
        },600);
      }
    });

    //发票滑出框保存按钮
    $('.js-save').click(function () {
      if(isTabNor){
        //普通发票
        //获取表单元素的值
        data['t1'].title = $('input[name="title"]').val();
        data['t1'].con = $('input[name="ho-con"]:checked').data('v');
        if (!data['t1'].title) {
          JQbox.alert("请输入发票抬头");
          return false;
        }
        if (!data['t1'].con) {
          JQbox.alert("请选择发票内容");
          return false;
        }

        if(data['t1'].title != null && data['t1'].title != undefined && data['t1'].title != ''){
          $('#inv').val(JSON.stringify(data['t1']));
          $('.js-title').html(data['t1'].title);
          $('.js-con').html(data['t1'].con);
        }
      }else{
        //增值税发票
        data['t2'].com_name = $('input[name="com_name"]').val();
        data['t2'].com_code = $('input[name="com_code"]').val();
        data['t2'].com_address = $('input[name="com_address"]').val();
        data['t2'].com_phone = $('input[name="com_phone"]').val();
        data['t2'].com_bank = $('input[name="com_bank"]').val();
        data['t2'].com_bankAccount = $('input[name="com_bankAccount"]').val();
        data['t2'].con = $('input[name="ho-con2"]:checked').data('v');

        if (!data['t2'].com_name) {
          JQbox.alert("请输入单位名称");
          return false;
        }
        if (!data['t2'].com_code) {
          JQbox.alert("请输入纳税人识别码");
          return false;
        }
        if (!data['t2'].com_address) {
          JQbox.alert("请输入注册地址");
          return false;
        }
        if (!data['t2'].com_phone) {
          JQbox.alert("请输入注册电话");
          return false;
        }
        if (!data['t2'].com_bank) {
          JQbox.alert("请输入开户银行");
          return false;
        }
        if (!data['t2'].com_bankAccount) {
          JQbox.alert("请输入银行账户");
          return false;
        }

        if (!data['t2'].con) {
          JQbox.alert("请选择发票内容");
          return false;
        }

        if(data['t2'].com_name != null && data['t2'].com_name != undefined && data['t2'].com_name != ''){
          $('#inv').val(JSON.stringify(data['t2']));
          $('.js-title').html(data['t2'].com_name);
          $('.js-con').html(data['t2'].con);
        }
      }

      isExist = true;
      var jsonStr = JSON.stringify(data);
      $.cookie('tabData', jsonStr, { expires: 7,path:"/",domain:"shop.golddiy.com"});

      switchCtrl(true);
      isOpen = true;

      $('.pop-up').height('0');
      setTimeout(function(){
        $('#popUpWrap').addClass('none');
      },600);

    });

    //tab切换
    var click_obj  = $('.js-tab').find('li');
    var tab_obj = $('.js-tab').siblings();
    $(click_obj).click(function(){

      $('input[name="title"]').val('');
      $('input[name="ho-con"]').each(function(){
        $(this).attr("checked",false);
      });

      $('input[name="com_name"]').val('');
      $('input[name="com_code"]').val('');
      $('input[name="com_address"]').val('');
      $('input[name="com_phone"]').val('');
      $('input[name="com_bank"]').val('');
      $('input[name="com_bankAccount"]').val('');
      $('input[name="ho-con2"]').each(function(){
        $(this).attr("checked",false);
      });

      $(click_obj).removeClass('order-cur');
      $(this).addClass('order-cur');

      var tp = $('.order-cur').data('type');
      tp == 'normal' ? isTabNor = true : isTabNor = false;

      var ind = $(this).index();
      $(tab_obj).addClass('hide');
      $(tab_obj).eq(ind).removeClass('hide');
    });


    //订单优惠
    $('.js-buy-coup').change(function () {
      if($(this).attr('checked')){
        $('.js-buy-ani').height('40px');
      }else{
        $('.js-buy-ani').height('0px');
      }
    });

    var arrChk = $(".js-buy-cal");
    var prices = '0.00';
    var couponNum = '0.00';
    var expreeVal = '0.00';
    $(arrChk).each(function(){
      var num = $(this).find('.js-buy-num').data('num');
      var price = $(this).find('.js-buy-price').data('price');
      prices = new BigDecimal(num.toString()).multiply(new BigDecimal(price.toString())).add(new
        BigDecimal(prices.toString()));
    });
    expreeVal = $(".chooseExpress").find("option:selected").data('value');

    couponNum = $('.js-couponInfo-price').data('coupon_pri');
    if(typeof couponNum == 'undefined'){
      couponNum = 0;
    }
    $('.js-buy-listRmb').html(buyNow.countPrice(prices, couponNum, expreeVal).toString());

    $('.js-useCoup').click(function () {

      JQAjax.post(this,{
        url : "http://test.shop.golddiy.com/shop/10001/ajax/validcoupon",
        form : {
          "products" : [{"ProductId":"44","RealPrice":"39800.00","DiscountPrice":"39800.00","Count":1,"DiscountId":0}],
          "code" : $('#input-coupon-code').val()
        },
        wait : true

      });
    });

    $('#order-btn').click(function () {
      var obj = $(this);
      if (!obj.hasClass('wei-bg-white')) {
        obj.removeClass('wei-bg-sRed').addClass('wei-bg-white').val('订单提交中...');
        var wait = GetRandomNum(0, 3);
        var interval = setInterval(function () {
          var time = --wait;
          if (time <= 0) {
            JQAjax.post(obj, {
              url: $('#order-form').attr('action'),
              form: 'order-form',
              wait: true
            });
            clearInterval(interval);
          }
        }, 1000);
      }
    });
  });


  function success_coupon(coupon_price) {
    couponNum = coupon_price;

    $('.js-buy-coup').attr('checked', false);
    $('.js-buy-ani').height('0px');

    var prices = 0.00;
    $('.js-buy-cal').each(function(){
      var num = $(this).find('.js-buy-num').data('num');
      var price = $(this).find('.js-buy-price').data('price');
      prices = new BigDecimal(num.toString()).multiply(new BigDecimal(price.toString())).add(new
        BigDecimal(prices.toString()));
    });
    expreeVal = $(".chooseExpress").find("option:selected").data('value');

    $('#coupon_code').val($('#input-coupon-code').val());

    $('.js-couponInfo-price').data('coupon_pri', couponNum);
    $('.js-couponInfo-price >span').html(couponNum + '元');
    $('.js-couponInfo-price').removeClass('hide');
    $('.js-buy-listRmb').html(buyNow.countPrice(prices, couponNum, expreeVal).toString());

  }
</script>
</body>
</html>
