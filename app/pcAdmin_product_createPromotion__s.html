<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>微店</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Apple devices fullscreen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Apple devices fullscreen -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" type="text/css" href="Public/css/bootstrap_min.css" media="all">
    <link rel="stylesheet" type="text/css" href="Public/css/bootstrap_responsive_min.css" media="all">
    <link rel="stylesheet" type="text/css" href="Public/css/jqui/jquery-ui.min.css" media="all">
    <link rel="stylesheet" type="text/css" href="promotion.css">
</head>
<body>
<div class="pro-container">
  <form id="discount-form" class="form-horizontal" action="http://sh.jinniuhuangjin.com/admin/discount"
        method="post">
    <div class="goods-list">
      <div class="js-list-filter-region clearfix ui-box" style="position: relative; min-height: 28px;">
        <a class="btn orange-btn fc12" href="http://sh.jinniuhuangjin.com/admin/discount">放弃</a>
      </div>
      <div class="ui-box">
        <div class="accordion" id="accordion2">
          <div class="accordion-group">
            <div class="accordion-heading">
              <a class="js-step-title1 accordion-toggle" href="javascript:;">
                第一步&nbsp;设置活动名称和促销时段
              </a>
            </div>
            <div id="collapseOne" class="accordion-body collapse in">
              <div class="accordion-inner">
                <div class="control-group">
                  <label class="control-label" for="name"
                         style="line-height: 28px">设置促销活动：</label>

                  <div class="controls">
                    <input type="text" id="name" name="name" value="">
                  </div>
                </div>
                <div class="control-group">
                  <label class="control-label" for="close_time" style="line-height: 28px">订单关闭时间：</label>

                  <div class="controls">
                    <div class="input-prepend input-append">
                      <input type="text" id="close_time" name="close_time" value="">
                      <span class="add-on">分钟</span>
                    </div>
                  </div>
                </div>
                <div class="control-group">
                  <label class="control-label" for="begin_time" style="line-height: 28px">
                    促销开始时间：</label>

                  <div class="controls">
                    <input type="text" id="begin_time" name="begin_time"
                           value="2015-02-04 09:48"
                           onclick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm'})" class="Wdate"
                           readonly>
                  </div>
                </div>
                <div class="control-group">
                  <label class="control-label" for="end_time" style="line-height: 28px">
                    促销结束时间：</label>

                  <div class="controls">
                    <input type="text" id="end_time" name="end_time" value="2015-02-04 09:48"
                           onclick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm'})" class="Wdate"
                           readonly>
                  </div>
                </div>
                <div class="control-group">
                  <div class="controls">
                    <a class="js-step1 btn orange-btn fc12"
                       href="javascript:;">&emsp;确定&emsp;</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="accordion-group">
            <div class="accordion-heading">
              <a class="js-step-title2 accordion-toggle" href="javascript:;">
                第二步&nbsp;选择宝贝
              </a>
            </div>
            <div id="collapseTwo" class="accordion-body collapse">
              <div class="accordion-inner">
                <div class="row-fluid">
                  <div class="span2">
                    <select id="category_id" class="choose-select">
                      <option value="">全部宝贝</option>

                      <option value="14">纪念币</option>

                      <option value="17">国礼</option>

                      <option value="27">纪念章</option>

                      <option value="33">纪念钞及邮币卡</option>

                      <option value="34">玉翠珠宝</option>

                      <option value="40">转运珠</option>

                      <option value="49">工艺礼品</option>

                    </select>
                  </div>
                  <div class="span2">
                    <input type="text" id="like_name" value="" class="" placeholder="宝贝名称"
                           style="width: 100%;">
                  </div>
                  <div class="span2">
                    <a id="filter-btn" class="btn orange-btn fc12" href="javascript:;">&emsp;搜索&emsp;</a>
                  </div>
                  <div class="span5">
                  </div>
                </div>
                <div class="ui-box">
                  <table class="ui-table ui-table-list" style="padding: 0px;">
                    <thead class="js-list-header-region tableFloatingHeaderOriginal">
                    <tr>
                      <th class="text-center">商品名称</th>
                      <th class="text-center">商品编码</th>
                      <th class="text-center">商品价格</th>
                      <th class="text-center">操作</th>
                    </tr>
                    </thead>
                    <tbody id="goods-list">
                    </tbody>
                  </table>
                  <div class="pagination text-right">
                  </div>
                </div>
                <a class="js-step2 btn orange-btn fc12" href="javascript:;">完成选择</a>
              </div>
            </div>
          </div>
          <div class="accordion-group">
            <div class="accordion-heading">
              <a class="js-step-title3 accordion-toggle" href="javascript:;">
                第三步&nbsp;设置限时打折
              </a>
            </div>
            <div id="collapseThree" class="accordion-body collapse">
              <div class="accordion-inner">
                批量设置：限时折扣&nbsp;
                <input id="all_gift" type="text" class="input-small">
                &nbsp;折&emsp;每人限购数&nbsp;
                <select id="all_limitcount" style="border-radius: 0">
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="5">5</option>
                  <option value="100">100</option>
                </select>
                &nbsp;<a id="betchfill" class="btn orange-btn fc12"
                         href="javascript:;">&emsp;确定&emsp;</a>

                <div class="ui-box">
                  <table class="ui-table ui-table-list" style="padding: 0px;">
                    <thead class="js-list-header-region tableFloatingHeaderOriginal">
                    <tr>
                      <th class="text-center">宝贝</th>
                      <th class="text-center">一口价</th>
                      <th class="text-center">折扣</th>
                      <th class="text-center">折后价</th>
                      <th class="text-center">每人限购数</th>
                      <th class="text-center">操作</th>
                    </tr>
                    </thead>
                    <tbody id="accept-list">
                    </tbody>
                  </table>

                </div>
                <a id="submit-btn" class="btn orange-btn fc12" href="javascript:;">完成创建</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
<script src="Public/js/jquery-1.8.3.js"></script>
<script src="Public/js/bootstrap_min.js"></script>

<script src="Public/js/jquery-ui.min.js"></script>
<script src="Public/js/jinniu.js"></script>

<script src="Public/js/WdatePicker/WdatePicker.js"></script>
<script>
$(function () {
    var _isAllSel = false;
    //定义selectAll的构造函数
    var selectAll = function (ele, opt) {
      this.$element = ele,
        this.defaults = {
        },
        this.options = $.extend({}, this.defaults, opt)
    };
    selectAll.prototype = {
      example: function () {
        return this.$element.css({
        });
      },
      isSelAll: function(evt){
        var checkedNum = $("input[class='js-check-toggle']:checked").length;
        var checksNum = $("input[class='js-check-toggle']").length;
        //alert(checkedNum + "+" + checksNum);
        if(checkedNum == checksNum){
          //全选
          _isAllSel = true;
        }
        else{
          _isAllSel = false;
        }
      }
    };
    //在插件中使用selectInit对象
    $.fn.SelectA = function (options) {
      var sel = new selectAll(this, options);
      $(this).click(function(){
        sel.isSelAll();
        if(!_isAllSel){
          $("input[class='js-check-toggle']").attr("checked", true);
        }
        else{
          $("input[class='js-check-toggle']").removeAttr("checked");
        }
      });
      $('.js-check-toggle').click(function () {
        sel.isSelAll();
        if(_isAllSel){
          $("input[id='js-check-all']").attr("checked", true);
        }
        else{
          $("input[id='js-check-all']").removeAttr("checked");
        }
      });
    };
    $('.collapse').collapse({toggle: false}); //初始化手风琴效果关闭
    $('#submit-btn').click(function () {
        JQAjax.post(this, {
            url: $('#discount-form').attr('action'),
            form: 'discount-form',
            wait: true
        });
    });

    var goodslist = {};
    var acceptlist = {};
    if (Object.keys(goodslist).length < 1) {
        JQAjax.get(null, {
            url: "http://sh.jinniuhuangjin.com/admin/discount/goodslist",
            callback: function (data) {
                result = eval('(' + data + ')');
                goodslist = result.list;
                add_goods_list(goodslist, acceptlist);
                $('.pagination').html(result.pager);
                return false;
            }
        });
    }

    $('#filter-btn').click(function () {
        var _param = '';
        if ($('#like_name').val()) {
            _param = _param + (_param != '' ? '&' : '?') + 'like_name=' + $('#like_name').val();
        }
        var url = "http://sh.jinniuhuangjin.com/admin/discount/goodslist" + _param;

        JQAjax.get(null, {
            url: url,
            callback: function (data) {
                result = eval('(' + data + ')');
                goodslist = result.list;
                add_goods_list(goodslist, acceptlist);
                $('.pagination').html(result.pager);
                return false;
            }
        });
    });

    $(document).on('click', '.pagination a', function () {
        var obj = $(this);
        JQAjax.get(obj, {
            url: obj.attr('href'),
            callback: function (data) {
                result = eval('(' + data + ')');
                goodslist = result.list;
                add_goods_list(goodslist, acceptlist);
                $('.pagination').html(result.pager);
                return false;
            }
        });
        return false;
    });
    $(document).on('click', '.joinClick', function () {
        var ele = $(this).data('goodsid');
        acceptlist[ele] = goodslist[ele];
        $(this).hide();
        $(this).siblings('.quitClick').show();
    });
    $(document).on('click', '.quitClick', function () {
        var ele = $(this).data('goodsid');
        temp = {};
        for (x in acceptlist) {
            if (x != ele) {
                temp[x] = acceptlist[x];
            }
        }
        acceptlist = temp;
        temp = {};
        $(this).siblings('.joinClick').show();
        $(this).hide();
    });
    $(document).on('click', '.delClick', function () {
        var ele = $(this).data('goodsid');
        temp = {};
        for (x in acceptlist) {
            if (x != ele) {
                temp[x] = acceptlist[x];
            }
        }
        acceptlist = temp;
        temp = {};
        $(this).parent().parent().remove();
    });

    $('#betchfill').click(function () {
        var _gift = $('#all_gift').val();
        var _limit = $('#all_limitcount').val();

        if (5 > _gift || $(this).val() >= 10) {
            JQbox.alert("请输入正确的折扣");
            return false;
        }
        change_discound_price(_gift);
        $('.limitClick').val(_limit);
    });
    $(document).on('blur', '.giftClick', function () {
        if (5 > $(this).val() || $(this).val() >= 10) {
            JQbox.alert("请输入正确的折扣");
        }
        $(this).parent().next('td').html($(this).val() * $(this).parent().data('price') / 10);
    });


    $('#js-check-all').SelectA();
    $('.js-step1').click(function () {
        if ($('#name').val() == '') {
            JQbox.alert('请输入活动名称');
            return false;
        }
        if ($('#begin_time').val() == '') {
            JQbox.alert('请输入活动开始时间');
            return false;
        }
        if ($('#end_time').val() == '') {
            JQbox.alert('请输入活动结束时间');
            return false;
        }
        $("#collapseOne").collapse('hide');
        $('#collapseTwo').collapse('show');
    });
    $('.js-step-title1').click(function () {
        $('.collapse').collapse('hide');
        $("#collapseOne").collapse('show');
    });

    $('.js-step2').click(function () {

        if (Object.keys(acceptlist).length < 1) {
            JQbox.alert('请先选择促销的宝贝');
            return false;
        }

        if (Object.keys(acceptlist).length > 0) {
            add_accept_list(acceptlist);
        }
        $("#collapseTwo").collapse('hide');
        $('#collapseThree').collapse('show');
    });
    $('.js-step-title2').click(function () {
        $('.collapse').collapse('hide');
        $("#collapseTwo").collapse('show');
    });

    $('.js-step-title3').click(function () {
        $('.collapse').collapse('hide');
        $("#collapseThree").collapse('show');
    });
});

function add_goods_list(goods_list, accept_list) {
    var str = '';
    for (p in goods_list) {
        var joined = '';
        var outed = '';
        if (accept_list[p] == undefined) {
            outed = ' style="display:none;"';
        } else {
            joined = ' style="display:none;"';

        }
        str += '<tr>';
        str += '<td class="text-left"><img src="' + goods_list[p]['simg'] + '" width="50px">' + goods_list[p]['name'] + '</td>';
        str += '<td class="text-center">' + goods_list[p]['stock_count'] + '</td>';
        str += '<td class="text-center">' + goods_list[p]['price'] + '</td>';
        str += '<td class="text-center">';
        str += '<a class="joinClick fc12" data-goodsid="' + goods_list[p]['id'] + '" ' + joined + ' href="javascript:;">参加打折</a>';
        str += '<a class="quitClick fc12" data-goodsid="' + goods_list[p]['id'] + '" ' + outed + ' href="javascript:;">不参加了</a>';
        str += '</td>';
        str += '</tr>';
    }
    $('#goods-list').html(str);
}

function add_accept_list(goods_list) {
    var str = '';
    for (p in goods_list) {
        _gift = goods_list[p]['discount_rate'] || '';
        _gift_price = (goods_list[p]['discount_rate'] ? goods_list[p]['discount_rate'] * goods_list[p]['price'] / 10 : goods_list[p]['price']);

        str += '<tr>';
        str += '<td class="text-left"><input name="goods_ids[]" type="hidden" value="' + goods_list[p]['id'] + '">';
        str += '<img src="' + goods_list[p]['simg'] + '" width="50px">' + goods_list[p]['name'] + '</td>';
        str += '<td class="text-center">' + goods_list[p]['price'] + '</td>';
        str += '<td class="text-center" data-price="' + goods_list[p]['price'] + '"><input name="gifts[]" type="text" class="giftClick" value="' + _gift + '" style="width: 50%">&nbsp;折</td>';
        str += '<td class="text-center">' + _gift_price + '</td>';
        str += '<td class="text-center">';
        str += '<select name="limitCounts[]" class="limitClick" style="width: 50%;border-radius: 0">';
        /* */
        str += '<option value="1" ' + (goods_list[p]['signle_count'] == 1 ? 'selected' : '') + '>1</option>';
        /**/
        str += '<option value="2" ' + (goods_list[p]['signle_count'] == 2 ? 'selected' : '') + '>2</option>';
        /**/
        str += '<option value="5" ' + (goods_list[p]['signle_count'] == 5 ? 'selected' : '') + '>5</option>';
        /**/
        str += '<option value="100" ' + (goods_list[p]['signle_count'] == 100 ? 'selected' : '') + '>100</option>';
        /* */
        str += '</select>';
        str += '</td>';
        str += '<td class="text-center"><input name="rate_id" type="hidden" value="' + goods_list[p]['rate_id'] + '"> ' +
                '<a class="delClick fc12" data-goodsid="' + goods_list[p]['id'] + '" href="javascript:;">删除</a></td>';
        str += '</tr>';
    }
    $('#accept-list').html(str);
}

function change_discound_price(discount) {
    $('.giftClick').each(function () {
        $(this).val(discount);
        $(this).parent().next('td').html(discount * $(this).parent().data('price') / 10);

    });

}

</script>
</body>
</html>
